<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comet — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080b10;--surface:#0f1420;--surface2:#131925;--surface3:#1a2235;--surface4:#1f2840;
  --border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.1);--border3:rgba(255,255,255,0.04);
  --fg:#f0f4ff;--fg2:#8892a4;--fg3:#3d4a5c;
  --green:#00f5a0;--green-glow:rgba(0,245,160,0.12);--green-dim:rgba(0,245,160,0.08);
  --red:#ff4d6d;--red-dim:rgba(255,77,109,0.08);
  --amber:#ffb830;--amber-dim:rgba(255,184,48,0.08);
  --blue:#4d9fff;--blue-dim:rgba(77,159,255,0.08);
  --side:230px;
}
html,body{height:100%;background:var(--bg);color:var(--fg);font-family:'DM Sans',sans-serif;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 100% 60% at 10% 0%, rgba(0,245,160,0.03) 0%,transparent 50%);pointer-events:none;z-index:0;}
.site-nav{height:44px;background:rgba(8,11,16,0.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px;flex-shrink:0;z-index:200;position:relative;}
.site-brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--fg);}
.brand-mark-sm{width:24px;height:24px;border-radius:7px;background:linear-gradient(135deg,var(--green),#00c97a);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:11px;font-weight:800;color:#000;}
.site-brand-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.site-nav-links{display:flex;align-items:center;gap:20px;margin-left:20px;}
.site-nav-links a{color:var(--fg2);text-decoration:none;font-size:12px;}
.site-nav-right{margin-left:auto;display:flex;align-items:center;gap:12px;}
.nav-signout{font-size:12px;color:var(--fg3);text-decoration:none;padding:4px 10px;border:1px solid var(--border);border-radius:7px;}
.shell{display:flex;height:calc(100vh - 44px);position:relative;z-index:1;}
.sidebar{width:var(--side);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.sidebar-top{padding:18px 16px;border-bottom:1px solid var(--border);}
.brand{display:flex;align-items:center;gap:10px;}
.brand-mark{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--green),#00c97a);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:#000;}
.brand-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.brand-sub{font-size:10px;color:var(--fg2);}
.nav{flex:1;padding:10px 8px;overflow-y:auto;}
.nav-sect{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--fg3);padding:10px 8px 4px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:10px;font-size:13px;color:var(--fg2);cursor:pointer;transition:all 0.15s;user-select:none;margin-bottom:1px;}
.nav-item:hover{color:var(--fg);background:var(--surface3);}
.nav-item.active{color:var(--green);background:var(--green-dim);}
.sidebar-foot{padding:12px 10px;border-top:1px solid var(--border);}
.user-row{display:flex;align-items:center;gap:9px;}
.user-av{width:30px;height:30px;border-radius:50%;background:var(--surface3);border:1px solid var(--border2);overflow:hidden;flex-shrink:0;}
.user-av img{width:100%;height:100%;object-fit:cover;}
.user-av-ph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--green);}
.user-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-role{font-size:10px;color:var(--fg2);}
.logout-btn{margin-left:auto;background:none;border:none;color:var(--fg3);cursor:pointer;padding:4px;border-radius:6px;text-decoration:none;display:flex;align-items:center;}
.content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:52px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;gap:12px;flex-shrink:0;}
.page-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.page-tag{font-size:9px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;padding:3px 9px;border-radius:20px;background:var(--surface3);border:1px solid var(--border2);color:var(--fg2);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
.filter-sel{background:var(--surface3);border:1px solid var(--border2);border-radius:8px;color:var(--fg);font-family:'DM Sans',sans-serif;font-size:11px;padding:5px 10px;outline:none;cursor:pointer;}
.main{flex:1;overflow-y:auto;padding:24px;}
.panel{display:none;}
.panel.active{display:block;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px 20px;position:relative;overflow:hidden;}
.stat-glow{position:absolute;top:0;left:0;right:0;height:1px;}
.stat-card.red .stat-glow{background:linear-gradient(90deg,transparent,var(--red),transparent);}
.stat-card.amber .stat-glow{background:linear-gradient(90deg,transparent,var(--amber),transparent);}
.stat-card.green .stat-glow{background:linear-gradient(90deg,transparent,var(--green),transparent);}
.stat-card.blue .stat-glow{background:linear-gradient(90deg,transparent,var(--blue),transparent);}
.stat-label{font-size:10px;font-weight:500;letter-spacing:0.06em;text-transform:uppercase;color:var(--fg2);margin-bottom:10px;}
.stat-num{font-family:'Syne',sans-serif;font-size:32px;font-weight:700;}
.stat-card.red .stat-num{color:var(--red);}
.stat-card.amber .stat-num{color:var(--amber);}
.stat-card.green .stat-num{color:var(--green);}
.stat-card.blue .stat-num{color:var(--fg);}
.stat-sub{font-size:10px;color:var(--fg3);margin-top:4px;}
.league-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
.league-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;}
.league-label{font-size:10px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg2);margin-bottom:4px;}
.league-count{font-family:'Syne',sans-serif;font-size:28px;font-weight:700;}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.section-title{font-size:10px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg2);}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;font-size:9px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg3);padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);}
tbody tr{border-bottom:1px solid var(--border3);cursor:pointer;transition:background 0.1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--surface2);}
td{padding:12px 16px;font-size:12px;}
td.mono{font-family:'DM Mono',monospace;font-size:11px;}
td.dim{color:var(--fg2);font-size:11px;}
.vp{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;padding:3px 10px;border-radius:20px;}
.vp::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.vp.CHEATER,.vp.AUTO-FAIL,.vp.AUTO_FAIL{color:var(--red);background:var(--red-dim);border:1px solid rgba(255,77,109,0.2);}.vp.REVIEW{color:var(--amber);background:var(--amber-dim);border:1px solid rgba(255,184,48,0.2);}
.vp.CHEATER::before,.vp.AUTO-FAIL::before,.vp.AUTO_FAIL::before,.vp.REVIEW::before{background:var(--amber);}
.vp.SUSPICIOUS,.vp.REVIEW{color:var(--amber);background:var(--amber-dim);border:1px solid rgba(255,184,48,0.2);}
.vp.SUSPICIOUS::before,.vp.REVIEW::before{background:var(--amber);}
.vp.CLEAN{color:var(--green);background:var(--green-dim);border:1px solid rgba(0,245,160,0.2);}
.vp.CLEAN::before{background:var(--green);}
.vp.UNKNOWN,.vp.PENDING{color:var(--fg2);background:var(--surface3);border:1px solid var(--border);}
.vp.UNKNOWN::before,.vp.PENDING::before{background:var(--fg3);}
.pin-gen-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px;max-width:560px;}
.pin-gen-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:4px;}
.pin-gen-sub{font-size:12px;color:var(--fg2);line-height:1.6;margin-bottom:18px;}
.pin-row{display:flex;gap:8px;}
.pin-sel{background:var(--surface3);border:1px solid var(--border2);border-radius:10px;color:var(--fg);font-family:'DM Sans',sans-serif;font-size:12px;padding:9px 12px;outline:none;cursor:pointer;flex:1;}
.btn-primary{background:var(--green);color:#000;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;padding:9px 20px;cursor:pointer;box-shadow:0 0 20px var(--green-glow);white-space:nowrap;}
.btn-primary:hover{opacity:0.9;}
.pin-result{margin-top:20px;display:none;background:var(--surface2);border:1px solid var(--border2);border-radius:14px;padding:18px;}
.pin-result.show{display:block;}
.pin-display-wrap{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.pin-code{font-family:'DM Mono',monospace;font-size:30px;font-weight:500;letter-spacing:0.24em;color:var(--green);text-shadow:0 0 20px rgba(0,245,160,0.4);}
.copy-btn{background:var(--surface3);border:1px solid var(--border2);border-radius:10px;color:var(--fg2);font-family:'DM Sans',sans-serif;font-size:11px;padding:10px 16px;cursor:pointer;white-space:nowrap;}
.copy-btn:hover{color:var(--fg);border-color:var(--green);}
.pin-meta{font-size:11px;color:var(--fg2);line-height:2;margin-bottom:12px;}
.pin-results-link{display:inline-flex;align-items:center;gap:6px;color:var(--blue);text-decoration:none;font-size:12px;background:var(--blue-dim);border:1px solid rgba(77,159,255,0.2);border-radius:8px;padding:7px 14px;}
.status-pill{display:inline-block;font-size:9px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;padding:2px 8px;border-radius:20px;}
.status-pill.active{color:var(--green);background:var(--green-dim);border:1px solid rgba(0,245,160,0.2);}
.status-pill.used{color:var(--fg3);background:var(--surface3);border:1px solid var(--border);}
.role-sel{background:var(--surface3);border:1px solid var(--border);border-radius:7px;color:var(--fg);font-family:'DM Sans',sans-serif;font-size:11px;padding:3px 8px;outline:none;}
.action-btn{background:none;border:none;color:var(--fg2);font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer;padding:3px 8px;border-radius:6px;}
.action-btn.del:hover{color:var(--red);}
.av-sm{width:22px;height:22px;border-radius:50%;vertical-align:middle;margin-right:6px;}
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface3);border:1px solid var(--border2);border-radius:12px;color:var(--fg);font-size:12px;padding:10px 16px;z-index:999;opacity:0;transform:translateY(8px);transition:all 0.2s;pointer-events:none;}
.toast.show{opacity:1;transform:none;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}
</style>
</head>
<body>
<header class="site-nav">
  <a href="/" class="site-brand">
    <div class="brand-mark-sm">C</div>
    <span class="site-brand-name">Comet</span>
  </a>
  <div class="site-nav-links">
    <a href="/">Home</a><a href="/download">Download</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a>
  </div>
  <div class="site-nav-right">
    <span style="font-size:12px;color:var(--fg2)">{{ user.username }}</span>
    <a href="/logout" class="nav-signout">Sign out</a>
  </div>
</header>
<div class="shell">
<nav class="sidebar">
  <div class="sidebar-top">
    <div class="brand">
      <div class="brand-mark">C</div>
      <div><div class="brand-name">Comet</div><div class="brand-sub">Forensic Portal</div></div>
    </div>
  </div>
  <div class="nav">
    <div class="nav-sect">Overview</div>
    <div class="nav-item active" onclick="go('overview',this)"><span style="font-size:13px;width:16px;text-align:center">⬡</span> Dashboard</div>
    <div class="nav-sect">Leagues</div>
    <div class="nav-item" onclick="go('uff',this)"><span style="font-size:13px;width:16px;text-align:center">◉</span> UFF Scans</div>
    <div class="nav-item" onclick="go('ffl',this)"><span style="font-size:13px;width:16px;text-align:center">◉</span> FFL Scans</div>
    {% if role in ('owner','admin') %}
    <div class="nav-item" onclick="go('all',this)"><span style="font-size:13px;width:16px;text-align:center">⬡</span> All Scans</div>
    {% endif %}
    <div class="nav-sect">Tools</div>
    <div class="nav-item" onclick="go('pins',this)"><span style="font-size:13px;width:16px;text-align:center">◈</span> PIN Manager</div>
    {% if role in ('owner','admin') %}
    <div class="nav-sect">Admin</div>
    <div class="nav-item" onclick="go('admin',this)"><span style="font-size:13px;width:16px;text-align:center">◈</span> Users</div>
    {% endif %}
  </div>
  <div class="sidebar-foot">
    <div class="user-row">
      <div class="user-av">
        {% set av = session.get('avatar','') if session else '' %}
        {% if av %}<img src="{{ av }}" alt="">
        {% else %}<div class="user-av-ph">{{ user.username[0].upper() }}</div>{% endif %}
      </div>
      <div style="min-width:0"><div class="user-name">{{ user.username }}</div><div class="user-role">{{ user.role }}</div></div>
      <a href="/logout" class="logout-btn">↪</a>
    </div>
  </div>
</nav>
<div class="content">
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <div class="page-tag" id="page-tag">OVERVIEW</div>
    <div class="topbar-right">
      <select class="filter-sel" id="lf" onchange="applyFilter()">
        <option value="">All Leagues</option><option value="UFF">UFF</option><option value="FFL">FFL</option>
      </select>
    </div>
  </div>
  <div class="main">
    <div class="panel active" id="panel-overview">
      <div class="stats-row">
        <div class="stat-card amber"><div class="stat-glow"></div><div class="stat-label">Needs Review</div><div class="stat-num" id="s-susp">—</div><div class="stat-sub">Hits detected</div></div>
        <div class="stat-card green"><div class="stat-glow"></div><div class="stat-label">Clean</div><div class="stat-num" id="s-clean">—</div><div class="stat-sub">No findings</div></div>
        <div class="stat-card blue"><div class="stat-glow"></div><div class="stat-label">Total Scans</div><div class="stat-num" id="s-total">—</div><div class="stat-sub">All time</div></div>
      </div>
      {% if role in ('owner','admin') %}
      <div class="league-row">
        <div class="league-card"><div><div class="league-label">UFF</div><div class="league-count" id="s-uff">—</div></div></div>
        <div class="league-card"><div><div class="league-label">FFL</div><div class="league-count" id="s-ffl">—</div></div></div>
      </div>{% endif %}
      <div class="section-head"><div class="section-title">Recent Scans</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>League</th><th>Status</th><th>Hits</th><th>Roblox Accounts</th><th>Time</th><th></th></tr></thead>
        <tbody id="overview-tbody"><tr><td colspan="7" style="padding:32px;text-align:center;color:var(--fg3)">Loading…</td></tr></tbody>
      </table></div>
    </div>
    <div class="panel" id="panel-uff">
      <div class="section-head"><div class="section-title">UFF Scans</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>Status</th><th>Hits</th><th>Roblox Accounts</th><th>Time</th><th></th></tr></thead>
        <tbody id="uff-tbody"><tr><td colspan="6" style="padding:32px;text-align:center;color:var(--fg3)">Loading…</td></tr></tbody>
      </table></div>
    </div>
    <div class="panel" id="panel-ffl">
      <div class="section-head"><div class="section-title">FFL Scans</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>Status</th><th>Hits</th><th>Roblox Accounts</th><th>Time</th><th></th></tr></thead>
        <tbody id="ffl-tbody"><tr><td colspan="6" style="padding:32px;text-align:center;color:var(--fg3)">Loading…</td></tr></tbody>
      </table></div>
    </div>
    {% if role in ('owner','admin') %}
    <div class="panel" id="panel-all">
      <div class="section-head"><div class="section-title">All Scans</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>League</th><th>Status</th><th>Hits</th><th>Roblox Accounts</th><th>Time</th><th></th></tr></thead>
        <tbody id="all-tbody"><tr><td colspan="7" style="padding:32px;text-align:center;color:var(--fg3)">Loading…</td></tr></tbody>
      </table></div>
    </div>{% endif %}
    <div class="panel" id="panel-pins">
      <div class="pin-gen-card">
        <div class="pin-gen-title">Generate PIN</div>
        <div class="pin-gen-sub">Create a one-time PIN for a screenshare session. Share it with the player — they enter it in the scanner. Results appear automatically when the scan finishes.</div>
        <div class="pin-row">
          <select class="pin-sel" id="pin-league">
            {% for lg in leagues %}<option value="{{ lg }}">{{ lg }}</option>{% endfor %}
          </select>
          <button class="btn-primary" onclick="genPin()">Generate PIN</button>
        </div>
        <div class="pin-result" id="pin-result">
          <div class="pin-display-wrap">
            <div class="pin-code" id="pin-code">--------</div>
            <button class="copy-btn" onclick="copyPin()">Copy PIN</button>
          </div>
          <div class="pin-meta" id="pin-meta"></div>
          <a class="pin-results-link" id="pin-results-link" href="#" target="_blank">↗ Watch results page live</a>
        </div>
      </div>
      <div class="section-head"><div class="section-title">Your PINs (last 3 kept)</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PIN</th><th>League</th><th>Status</th><th>Agent</th><th>Created</th><th>Expires</th><th>Finished</th><th>Results</th></tr></thead>
        <tbody id="pins-tbody"><tr><td colspan="8" style="padding:32px;text-align:center;color:var(--fg3)">No PINs yet</td></tr></tbody>
      </table></div>
    </div>
    {% if role in ('owner','admin') %}
    <div class="panel" id="panel-admin">
      <div class="section-head"><div class="section-title">User Management</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>User</th><th>Discord ID</th><th>Role</th><th>Leagues</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="admin-tbody"><tr><td colspan="6" style="padding:32px;text-align:center;color:var(--fg3)">Loading…</td></tr></tbody>
      </table></div>
    </div>{% endif %}
  </div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
const ROLE="{{role}}";
const LEAGUES={{leagues|tojson}};
let lastPin="";
const INFO={overview:["Dashboard","OVERVIEW"],uff:["UFF Scans","UFF"],ffl:["FFL Scans","FFL"],all:["All Scans","ADMIN"],pins:["PIN Manager","TOOLS"],admin:["Users","ADMIN"]};
function go(key,el){
  document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
  document.getElementById("panel-"+key).classList.add("active");
  if(el)el.classList.add("active");
  const[t,b]=INFO[key]||[key,key];
  document.getElementById("page-title").textContent=t;
  document.getElementById("page-tag").textContent=b;
  if(key==="overview"){loadStats();loadScans("overview","");}
  else if(key==="uff")loadScans("uff","UFF");
  else if(key==="ffl")loadScans("ffl","FFL");
  else if(key==="all")loadScans("all","");
  else if(key==="pins")loadPins();
  else if(key==="admin")loadAdmin();
}
function applyFilter(){const v=document.getElementById("lf").value;loadStats();loadScans("overview",v);}
async function loadStats(){
  try{
    const d=await(await fetch("/api/stats")).json();
    
    document.getElementById("s-susp").textContent=d.suspicious??"—";
    document.getElementById("s-clean").textContent=d.clean??"—";
    document.getElementById("s-total").textContent=d.total??"—";
    if(ROLE==="owner"||ROLE==="admin"){
      const u=document.getElementById("s-uff");const f=document.getElementById("s-ffl");
      if(u)u.textContent=d.uff??"—";if(f)f.textContent=d.ffl??"—";
    }
  }catch(e){}
}
function vc(v){if(!v)return"UNKNOWN";return v.toUpperCase().replace(/\s+/g,"-");}
async function loadScans(panel,league){
  const url="/api/scans"+(league?"?league="+league:"");
  try{
    const scans=await(await fetch(url)).json();
    const isAll=panel==="overview"||panel==="all";
    const tbody=document.getElementById(panel+"-tbody");
    if(!tbody)return;
    if(!scans.length){tbody.innerHTML=`<tr><td colspan="${isAll?7:6}" style="padding:32px;text-align:center;color:var(--fg3)">No scans yet</td></tr>`;return;}
    tbody.innerHTML=scans.map(s=>{
      const accs=(s.roblox_accs||[]).map(a=>typeof a==="object"?a.username:a).join(", ")||"—";
      const lg=isAll?`<td class="mono">${esc(s.league)}</td>`:"";
      return`<tr onclick="if(event.target.tagName!=='A')window.open('/results/${esc(s.pin_used||'')}','_blank')">
        <td class="mono">${esc(s.pc_user)}</td>${lg}
        <td><span class="vp ${vc(s.verdict)}">${esc(s.verdict||"UNKNOWN")}</span></td>
        <td class="mono" style="color:${s.total_hits>0?"var(--red)":"var(--fg3)"}">${s.total_hits}</td>
        <td class="dim" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(accs)}</td>
        <td class="dim">${s.submitted}</td>
        <td>${s.pin_used?`<a href="/results/${s.pin_used}" style="color:var(--blue);font-size:11px;text-decoration:none" target="_blank" onclick="event.stopPropagation()">View →</a>`:'<span style="color:var(--fg3);font-size:11px">—</span>'}</td>
      </tr>`;
    }).join("");
  }catch(e){console.error(e);}
}
async function genPin(){
  const league=document.getElementById("pin-league").value;
  if(!league){showToast("Select a league first");return;}
  try{
    const r=await fetch("/api/pins/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({league})});
    const d=await r.json();
    if(d.pin){
      lastPin=d.pin;
      document.getElementById("pin-code").textContent=d.pin;
      document.getElementById("pin-meta").innerHTML=`League: <strong>${esc(d.league)}</strong> &nbsp;·&nbsp; Expires: <strong>${esc(d.expires)} UTC</strong> &nbsp;·&nbsp; One-time use`;
      const link=document.getElementById("pin-results-link");
      link.href="/results/"+d.pin;
      document.getElementById("pin-result").classList.add("show");
      loadPins();showToast("PIN generated ✓");
    }else showToast("Error: "+(d.error||"unknown"));
  }catch(e){showToast("Network error: "+e.message);}
}
function copyPin(){if(!lastPin)return;navigator.clipboard.writeText(lastPin).then(()=>showToast("Copied: "+lastPin));}
async function loadPins(){
  try{
    const pins=await(await fetch("/api/pins")).json();
    const tbody=document.getElementById("pins-tbody");
    if(!pins.length){tbody.innerHTML='<tr><td colspan="8" style="padding:32px;text-align:center;color:var(--fg3)">No PINs yet — generate one above</td></tr>';return;}
    tbody.innerHTML=pins.map(p=>`<tr>
      <td class="mono" style="color:var(--green);letter-spacing:0.14em;font-size:13px">${esc(p.pin)}</td>
      <td class="mono">${esc(p.league)}</td>
      <td><span class="status-pill ${p.used?"used":"active"}">${p.used?"USED":"ACTIVE"}</span></td>
      <td class="dim">${esc(p.agent||"—")}</td>
      <td class="dim" style="font-size:10px">${esc(p.created)}</td>
      <td class="dim" style="font-size:10px">${esc(p.expires)}</td>
      <td class="dim" style="font-size:10px">${p.finished_at?esc(p.finished_at):'<span style="color:var(--fg3)">Pending</span>'}</td>
      <td><a href="/results/${esc(p.pin)}" style="color:${p.used?"var(--blue)":"var(--fg3)"};font-size:11px;text-decoration:none" target="_blank">${p.used?"View →":"Waiting…"}</a></td>
    </tr>`).join("");
  }catch(e){}
}
async function loadAdmin(){
  try{
    const users=await(await fetch("/api/admin/users")).json();
    const tbody=document.getElementById("admin-tbody");
    tbody.innerHTML=users.map(u=>`<tr>
      <td>${u.avatar?`<img src="https://cdn.discordapp.com/avatars/${u.discord_id}/${u.avatar}.png" class="av-sm">`:""}${esc(u.username)}</td>
      <td class="mono dim">${u.discord_id||"—"}</td>
      <td><select class="role-sel" onchange="updUser(${u.id},'role',this.value)">${["pending","agent","admin","owner"].map(r=>`<option ${u.role===r?"selected":""}>${r}</option>`).join("")}</select></td>
      <td><input style="background:var(--surface3);border:1px solid var(--border);border-radius:7px;color:var(--fg);font-size:11px;padding:3px 8px;outline:none;width:80px" value="${esc(u.leagues)}" onblur="updUser(${u.id},'leagues',this.value)"></td>
      <td class="dim">${u.created}</td>
      <td><button class="action-btn del" onclick="delUser(${u.id},'${esc(u.username)}')">Remove</button></td>
    </tr>`).join("");
  }catch(e){}
}
async function updUser(id,f,v){await fetch(`/api/admin/users/${id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({[f]:v})});showToast("Saved");}
async function delUser(id,n){if(!confirm(`Remove "${n}"?`))return;await fetch(`/api/admin/users/${id}`,{method:"DELETE"});loadAdmin();showToast("Removed");}
function esc(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2500);}
loadStats();loadScans("overview","");
</script>
</body>
</html>

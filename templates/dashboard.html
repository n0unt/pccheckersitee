<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Checker — Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:    #080808;
  --bg2:   #0f0f0f;
  --bg3:   #161616;
  --bg4:   #1e1e1e;
  --bdr:   #202020;
  --bdr2:  #2a2a2a;
  --fg:    #f0f0f0;
  --fg2:   #777777;
  --fg3:   #333333;
  --fg4:   #444444;
  --red:   #ff3b3b;
  --amber: #ffb703;
  --green: #2aff8f;
  --blue:  #4da6ff;
  --side:  220px;
}
html, body { height: 100%; background: var(--bg); color: var(--fg); font-family: 'DM Sans', sans-serif; overflow: hidden; }

/* ── Layout ── */
.shell { display: flex; height: 100vh; }

/* ── Sidebar ── */
.sidebar {
  width: var(--side);
  background: var(--bg2);
  border-right: 1px solid var(--bdr);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
.sidebar-logo {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--bdr);
}
.sidebar-logo .mark {
  font-family: 'DM Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.12em;
  color: var(--fg);
}
.sidebar-logo .sub {
  font-size: 10px;
  color: var(--fg2);
  margin-top: 3px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.08em;
}
.nav { flex: 1; padding: 12px 0; overflow-y: auto; }
.nav-section {
  font-size: 9px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.18em;
  color: var(--fg3);
  text-transform: uppercase;
  padding: 12px 20px 6px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 400;
  color: var(--fg2);
  cursor: pointer;
  transition: all 0.12s;
  border-left: 2px solid transparent;
  user-select: none;
}
.nav-item:hover { color: var(--fg); background: var(--bg3); }
.nav-item.active { color: var(--fg); background: var(--bg3); border-left-color: var(--fg); }
.nav-item .ico { font-size: 14px; width: 18px; text-align: center; opacity: 0.7; }
.nav-item.active .ico { opacity: 1; }

.sidebar-foot {
  padding: 16px 20px;
  border-top: 1px solid var(--bdr);
  font-size: 12px;
}
.user-chip {
  display: flex;
  align-items: center;
  gap: 10px;
}
.user-avatar {
  width: 28px; height: 28px;
  background: var(--bg4);
  border: 1px solid var(--bdr2);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px;
  font-family: 'DM Mono', monospace;
  color: var(--fg2);
  flex-shrink: 0;
}
.user-info .name { font-weight: 500; font-size: 12px; color: var(--fg); }
.user-info .role {
  font-size: 10px;
  color: var(--fg2);
  font-family: 'DM Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.logout-btn {
  margin-left: auto;
  font-size: 11px;
  color: var(--fg3);
  text-decoration: none;
  transition: color 0.12s;
}
.logout-btn:hover { color: var(--red); }

/* ── Content area ── */
.content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.topbar {
  height: 52px;
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  padding: 0 28px;
  gap: 16px;
  flex-shrink: 0;
  background: var(--bg2);
}
.page-title { font-size: 14px; font-weight: 600; color: var(--fg); }
.badge {
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.08em;
  padding: 3px 8px;
  border: 1px solid var(--bdr2);
  color: var(--fg2);
}
.topbar-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }

.league-filter {
  background: var(--bg3);
  border: 1px solid var(--bdr);
  color: var(--fg);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  padding: 6px 10px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
}

.main { flex: 1; overflow-y: auto; padding: 28px; }

/* ── Panels ── */
.panel { display: none; }
.panel.active { display: block; }

/* ── Stats row ── */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
.stat-card {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  padding: 20px;
  position: relative;
}
.stat-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
}
.stat-card.red::after   { background: var(--red); }
.stat-card.amber::after { background: var(--amber); }
.stat-card.green::after { background: var(--green); }
.stat-card.blue::after  { background: var(--blue); }
.stat-label { font-size: 10px; font-family: 'DM Mono', monospace; letter-spacing: 0.1em; color: var(--fg2); text-transform: uppercase; margin-bottom: 10px; }
.stat-num { font-size: 32px; font-weight: 600; letter-spacing: -0.03em; color: var(--fg); }
.stat-sub { font-size: 11px; color: var(--fg2); margin-top: 4px; }

/* ── League split ── */
.league-split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
.league-card {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  padding: 18px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.league-name { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--fg2); }
.league-count { font-size: 26px; font-weight: 600; color: var(--fg); }

/* ── Table ── */
.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.section-title { font-size: 11px; font-family: 'DM Mono', monospace; letter-spacing: 0.12em; text-transform: uppercase; color: var(--fg2); }
.table-wrap { background: var(--bg2); border: 1px solid var(--bdr); overflow: hidden; }
table { width: 100%; border-collapse: collapse; }
thead th {
  text-align: left;
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--fg2);
  padding: 10px 16px;
  border-bottom: 1px solid var(--bdr);
  font-weight: 500;
  background: var(--bg3);
}
tbody tr {
  border-bottom: 1px solid var(--bdr);
  cursor: pointer;
  transition: background 0.1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--bg3); }
td {
  padding: 12px 16px;
  font-size: 13px;
  color: var(--fg);
}
td.mono { font-family: 'DM Mono', monospace; font-size: 12px; }
td.dim { color: var(--fg2); font-size: 12px; }

.verdict-pill {
  display: inline-block;
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.08em;
  padding: 3px 8px;
  text-transform: uppercase;
  font-weight: 500;
}
.verdict-pill.CHEATER    { color: var(--red);   border: 1px solid rgba(255,59,59,0.3);   background: rgba(255,59,59,0.06); }
.verdict-pill.SUSPICIOUS { color: var(--amber); border: 1px solid rgba(255,183,3,0.3);   background: rgba(255,183,3,0.06); }
.verdict-pill.CLEAN      { color: var(--green); border: 1px solid rgba(42,255,143,0.3);  background: rgba(42,255,143,0.06); }
.verdict-pill.UNKNOWN    { color: var(--fg2);   border: 1px solid var(--bdr); }

/* ── Detail modal ── */
.modal-bg {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  display: none; align-items: center; justify-content: center;
  z-index: 100;
  backdrop-filter: blur(4px);
}
.modal-bg.open { display: flex; }
.modal {
  background: var(--bg2);
  border: 1px solid var(--bdr2);
  width: 720px;
  max-height: 82vh;
  display: flex;
  flex-direction: column;
  animation: modal-in 0.2s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes modal-in { from{opacity:0;transform:scale(0.97)} to{opacity:1;transform:scale(1)} }
.modal-head {
  padding: 20px 24px;
  border-bottom: 1px solid var(--bdr);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.modal-title { font-size: 15px; font-weight: 600; }
.modal-close {
  margin-left: auto;
  background: none;
  border: none;
  color: var(--fg2);
  font-size: 20px;
  cursor: pointer;
  line-height: 1;
  transition: color 0.12s;
}
.modal-close:hover { color: var(--fg); }
.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.detail-item { background: var(--bg3); border: 1px solid var(--bdr); padding: 14px 16px; }
.detail-label { font-size: 10px; font-family: 'DM Mono', monospace; letter-spacing: 0.1em; text-transform: uppercase; color: var(--fg2); margin-bottom: 6px; }
.detail-value { font-size: 14px; font-weight: 500; color: var(--fg); }
.detail-value.mono { font-family: 'DM Mono', monospace; font-size: 12px; }

.report-section { margin-top: 16px; }
.report-label { font-size: 10px; font-family: 'DM Mono', monospace; letter-spacing: 0.1em; text-transform: uppercase; color: var(--fg2); margin-bottom: 8px; }
.report-pre {
  background: var(--bg);
  border: 1px solid var(--bdr);
  padding: 16px;
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  color: var(--fg2);
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 300px;
  overflow-y: auto;
  line-height: 1.6;
}

/* ── PIN panel ── */
.pin-generator {
  background: var(--bg2);
  border: 1px solid var(--bdr);
  padding: 28px;
  margin-bottom: 24px;
  max-width: 500px;
}
.pin-gen-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
.pin-gen-sub { font-size: 12px; color: var(--fg2); margin-bottom: 20px; }
.pin-row { display: flex; gap: 10px; align-items: center; }
.league-sel {
  background: var(--bg3);
  border: 1px solid var(--bdr);
  color: var(--fg);
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  padding: 10px 14px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  flex: 1;
}
.btn {
  background: var(--fg);
  color: var(--bg);
  border: none;
  font-family: 'DM Sans', sans-serif;
  font-size: 12px;
  font-weight: 600;
  padding: 10px 18px;
  cursor: pointer;
  transition: opacity 0.12s;
  white-space: nowrap;
}
.btn:hover { opacity: 0.85; }
.btn-ghost {
  background: transparent;
  color: var(--fg2);
  border: 1px solid var(--bdr);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  padding: 8px 14px;
  cursor: pointer;
  transition: all 0.12s;
}
.btn-ghost:hover { color: var(--fg); border-color: var(--bdr2); }

.pin-display {
  margin-top: 16px;
  display: none;
}
.pin-display.show { display: block; }
.pin-code {
  font-family: 'DM Mono', monospace;
  font-size: 28px;
  font-weight: 500;
  letter-spacing: 0.2em;
  color: var(--fg);
  background: var(--bg);
  border: 1px solid var(--bdr2);
  padding: 16px 20px;
  display: inline-block;
  margin-bottom: 8px;
}
.pin-meta { font-size: 11px; color: var(--fg2); font-family: 'DM Mono', monospace; }

/* ── Pins table ── */
.used-tag {
  font-size: 10px;
  font-family: 'DM Mono', monospace;
  padding: 2px 7px;
  border: 1px solid var(--bdr);
  color: var(--fg3);
}
.used-tag.active {
  color: var(--green);
  border-color: rgba(42,255,143,0.3);
  background: rgba(42,255,143,0.06);
}

/* ── Admin panel ── */
.admin-users { margin-bottom: 24px; }
.user-role-sel {
  background: var(--bg3);
  border: 1px solid var(--bdr);
  color: var(--fg);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  padding: 4px 8px;
  outline: none;
  cursor: pointer;
}
.action-btn {
  background: transparent;
  border: none;
  color: var(--fg2);
  font-family: 'DM Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  padding: 4px 8px;
  transition: color 0.12s;
}
.action-btn:hover { color: var(--fg); }
.action-btn.del:hover { color: var(--red); }

/* ── Empty state ── */
.empty { text-align: center; padding: 60px 20px; color: var(--fg2); font-size: 13px; }
.empty .ico { font-size: 32px; margin-bottom: 12px; opacity: 0.3; }

/* ── Scrollbar ── */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg4); }

/* ── Toast ── */
.toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--bg3);
  border: 1px solid var(--bdr2);
  color: var(--fg);
  font-size: 12px;
  font-family: 'DM Mono', monospace;
  padding: 12px 16px;
  z-index: 200;
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.2s;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>
<div class="shell">

<!-- Sidebar -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <div class="mark">PC CHECKER</div>
    <div class="sub">Forensic Portal</div>
  </div>
  <div class="nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" data-panel="overview" onclick="switchPanel('overview', this)">
      <span class="ico">◈</span> Dashboard
    </div>

    <div class="nav-section">Leagues</div>
    <div class="nav-item" data-panel="uff" onclick="switchPanel('uff', this)">
      <span class="ico">◉</span> UFF Scans
    </div>
    <div class="nav-item" data-panel="ffl" onclick="switchPanel('ffl', this)">
      <span class="ico">◉</span> FFL Scans
    </div>
    {% if role == 'owner' %}
    <div class="nav-item" data-panel="all" onclick="switchPanel('all', this)">
      <span class="ico">◈</span> All Scans
    </div>
    {% endif %}

    <div class="nav-section">Tools</div>
    <div class="nav-item" data-panel="pins" onclick="switchPanel('pins', this)">
      <span class="ico">◉</span> PIN Manager
    </div>

    {% if role == 'owner' %}
    <div class="nav-section">Admin</div>
    <div class="nav-item" data-panel="admin" onclick="switchPanel('admin', this)">
      <span class="ico">◉</span> Users
    </div>
    {% endif %}
  </div>
  <div class="sidebar-foot">
    <div class="user-chip">
      <div class="user-avatar">{{ user.username[0].upper() }}</div>
      <div class="user-info">
        <div class="name">{{ user.username }}</div>
        <div class="role">{{ user.role }}</div>
      </div>
      <a href="/logout" class="logout-btn" title="Sign out">→</a>
    </div>
  </div>
</nav>

<!-- Main content -->
<div class="content">
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <div class="badge" id="page-badge">OVERVIEW</div>
    <div class="topbar-right">
      <select class="league-filter" id="global-filter" onchange="applyFilter()">
        <option value="ALL">All Leagues</option>
        <option value="UFF">UFF</option>
        <option value="FFL">FFL</option>
      </select>
    </div>
  </div>

  <div class="main">

    <!-- OVERVIEW PANEL -->
    <div class="panel active" id="panel-overview">
      <div class="stats-row" id="stats-row">
        <div class="stat-card red">
          <div class="stat-label">Cheaters</div>
          <div class="stat-num" id="s-cheater">—</div>
          <div class="stat-sub">Flagged as cheater</div>
        </div>
        <div class="stat-card amber">
          <div class="stat-label">Suspicious</div>
          <div class="stat-num" id="s-susp">—</div>
          <div class="stat-sub">Needs review</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">Clean</div>
          <div class="stat-num" id="s-clean">—</div>
          <div class="stat-sub">No findings</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">Total Scans</div>
          <div class="stat-num" id="s-total">—</div>
          <div class="stat-sub">All time</div>
        </div>
      </div>

      {% if role == 'owner' %}
      <div class="league-split">
        <div class="league-card">
          <div>
            <div class="league-name">UFF</div>
            <div style="font-size:11px;color:var(--fg2);margin-top:2px;">Scans submitted</div>
          </div>
          <div class="league-count" id="s-uff">—</div>
        </div>
        <div class="league-card">
          <div>
            <div class="league-name">FFL</div>
            <div style="font-size:11px;color:var(--fg2);margin-top:2px;">Scans submitted</div>
          </div>
          <div class="league-count" id="s-ffl">—</div>
        </div>
      </div>
      {% endif %}

      <div class="section-head">
        <div class="section-title">Recent Scans</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>PC User</th>
              <th>League</th>
              <th>Verdict</th>
              <th>Hits</th>
              <th>Roblox Accounts</th>
              <th>Submitted</th>
            </tr>
          </thead>
          <tbody id="overview-tbody">
            <tr><td colspan="6" class="empty">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- UFF PANEL -->
    <div class="panel" id="panel-uff">
      <div class="section-head">
        <div class="section-title">UFF — Scan Results</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>PC User</th><th>Verdict</th><th>Hits</th><th>Roblox Accounts</th><th>Submitted</th></tr>
          </thead>
          <tbody id="uff-tbody"><tr><td colspan="5" class="empty">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- FFL PANEL -->
    <div class="panel" id="panel-ffl">
      <div class="section-head">
        <div class="section-title">FFL — Scan Results</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>PC User</th><th>Verdict</th><th>Hits</th><th>Roblox Accounts</th><th>Submitted</th></tr>
          </thead>
          <tbody id="ffl-tbody"><tr><td colspan="5" class="empty">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    {% if role == 'owner' %}
    <!-- ALL SCANS PANEL -->
    <div class="panel" id="panel-all">
      <div class="section-head">
        <div class="section-title">All Scans — Owner View</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>PC User</th><th>League</th><th>Verdict</th><th>Hits</th><th>Roblox Accounts</th><th>Submitted</th></tr>
          </thead>
          <tbody id="all-tbody"><tr><td colspan="6" class="empty">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- PINS PANEL -->
    <div class="panel" id="panel-pins">
      <div class="pin-generator">
        <div class="pin-gen-title">Generate scan PIN</div>
        <div class="pin-gen-sub">Create a one-time PIN to give to the player being screenshared.</div>
        <div class="pin-row">
          <select class="league-sel" id="pin-league">
            {% for l in leagues %}
            <option value="{{ l }}">{{ l }}</option>
            {% endfor %}
          </select>
          <button class="btn" onclick="generatePin()">Generate PIN</button>
        </div>
        <div class="pin-display" id="pin-display">
          <div class="pin-code" id="pin-code">————————</div>
          <div class="pin-meta" id="pin-meta"></div>
        </div>
      </div>

      <div class="section-head">
        <div class="section-title">PIN History</div>
        <button class="btn-ghost" onclick="loadPins()">Refresh</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>PIN</th><th>League</th><th>Status</th><th>Agent</th><th>Created</th><th>Expires</th></tr>
          </thead>
          <tbody id="pins-tbody"><tr><td colspan="6" class="empty">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    {% if role == 'owner' %}
    <!-- ADMIN PANEL -->
    <div class="panel" id="panel-admin">
      <div class="section-head">
        <div class="section-title">User Management</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Username</th><th>Role</th><th>Leagues</th><th>Joined</th><th>Actions</th></tr>
          </thead>
          <tbody id="admin-tbody"><tr><td colspan="5" class="empty">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
    {% endif %}

  </div><!-- /.main -->
</div><!-- /.content -->
</div><!-- /.shell -->

<!-- Detail Modal -->
<div class="modal-bg" id="modal-bg" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="modal-title">Scan Detail</div>
      <button class="modal-close" onclick="closeModalDirect()">×</button>
    </div>
    <div class="modal-body" id="modal-body">Loading…</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const ROLE = "{{ role }}";
const LEAGUES = {{ leagues | tojson }};
let currentPanel = 'overview';

function switchPanel(key, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + key).classList.add('active');
  if (el) el.classList.add('active');
  currentPanel = key;

  const titles = {
    overview: ['Dashboard', 'OVERVIEW'],
    uff: ['UFF Scans', 'UFF'],
    ffl: ['FFL Scans', 'FFL'],
    all: ['All Scans', 'OWNER'],
    pins: ['PIN Manager', 'TOOLS'],
    admin: ['User Management', 'ADMIN'],
  };
  const [title, badge] = titles[key] || [key, key];
  document.getElementById('page-title').textContent = title;
  document.getElementById('page-badge').textContent = badge;

  if (key === 'overview') { loadStats(); loadScans('overview', ''); }
  else if (key === 'uff')  loadScans('uff', 'UFF');
  else if (key === 'ffl')  loadScans('ffl', 'FFL');
  else if (key === 'all')  loadScans('all', '');
  else if (key === 'pins') { loadStats(); loadPins(); }
  else if (key === 'admin') loadAdmin();
}

function applyFilter() {
  const v = document.getElementById('global-filter').value;
  loadStats();
  if (currentPanel === 'overview') loadScans('overview', v === 'ALL' ? '' : v);
  else if (currentPanel === 'all') loadScans('all', v === 'ALL' ? '' : v);
}

// ── Stats ──
async function loadStats() {
  const r = await fetch('/api/stats');
  const d = await r.json();
  document.getElementById('s-cheater').textContent = d.cheater;
  document.getElementById('s-susp').textContent    = d.suspicious;
  document.getElementById('s-clean').textContent   = d.clean;
  document.getElementById('s-total').textContent   = d.total;
  if (ROLE === 'owner') {
    document.getElementById('s-uff').textContent = d.uff;
    document.getElementById('s-ffl').textContent = d.ffl;
  }
}

// ── Scans ──
async function loadScans(panel, league) {
  const url = '/api/scans' + (league ? `?league=${league}` : '');
  const r = await fetch(url);
  const scans = await r.json();

  const isAll = (panel === 'overview' || panel === 'all');
  const tbodyId = panel === 'overview' ? 'overview-tbody' : panel + '-tbody';
  const tbody = document.getElementById(tbodyId);
  if (!tbody) return;

  if (!scans.length) {
    tbody.innerHTML = `<tr><td colspan="${isAll ? 6 : 5}" style="padding:40px;text-align:center;color:var(--fg2);font-size:12px;">No scans yet</td></tr>`;
    return;
  }

  tbody.innerHTML = scans.map(s => {
    const accs = (s.roblox_accs || []).join(', ') || '—';
    const leagueTd = isAll ? `<td class="mono">${s.league}</td>` : '';
    return `<tr onclick="openScan(${s.id})">
      <td class="mono">${esc(s.pc_user)}</td>
      ${leagueTd}
      <td><span class="verdict-pill ${s.verdict}">${s.verdict}</span></td>
      <td class="mono">${s.total_hits}</td>
      <td class="dim" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(accs)}</td>
      <td class="dim">${s.submitted}</td>
    </tr>`;
  }).join('');
}

// ── Scan detail ──
async function openScan(id) {
  document.getElementById('modal-bg').classList.add('open');
  document.getElementById('modal-body').innerHTML = '<div style="padding:40px;text-align:center;color:var(--fg2);">Loading…</div>';
  const r = await fetch(`/api/scans/${id}`);
  const d = await r.json();

  const accs = (d.roblox_accs || []).map(a => `<div style="color:var(--amber);font-family:DM Mono,monospace;font-size:12px;margin:3px 0;">› ${esc(a)}</div>`).join('') || '<div style="color:var(--fg2);font-size:12px;">None detected</div>';

  document.getElementById('modal-title').innerHTML = `
    <span class="verdict-pill ${d.verdict}" style="margin-right:10px;">${d.verdict}</span>
    ${esc(d.pc_user)}
  `;
  document.getElementById('modal-body').innerHTML = `
    <div class="detail-grid">
      <div class="detail-item">
        <div class="detail-label">PC User</div>
        <div class="detail-value mono">${esc(d.pc_user)}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">League</div>
        <div class="detail-value mono">${esc(d.league)}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Total Hits</div>
        <div class="detail-value" style="color:${d.total_hits > 0 ? 'var(--red)' : 'var(--green)'}">${d.total_hits}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Submitted</div>
        <div class="detail-value mono" style="font-size:12px;">${d.submitted}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">PIN Used</div>
        <div class="detail-value mono">${esc(d.pin_used || '—')}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Scan ID</div>
        <div class="detail-value mono">#${d.id}</div>
      </div>
    </div>
    <div class="report-section">
      <div class="report-label">Roblox Accounts Detected</div>
      <div style="background:var(--bg3);border:1px solid var(--bdr);padding:14px 16px;margin-bottom:16px;">${accs}</div>
    </div>
    <div class="report-section">
      <div class="report-label">Full Report Data</div>
      <div class="report-pre">${esc(JSON.stringify(d.report, null, 2))}</div>
    </div>
  `;
}

function closeModal(e) {
  if (e.target === document.getElementById('modal-bg')) closeModalDirect();
}
function closeModalDirect() {
  document.getElementById('modal-bg').classList.remove('open');
}

// ── PIN Manager ──
async function generatePin() {
  const league = document.getElementById('pin-league').value;
  const r = await fetch('/api/pins/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({league})
  });
  const d = await r.json();
  if (d.pin) {
    document.getElementById('pin-code').textContent = d.pin;
    document.getElementById('pin-meta').textContent = `League: ${d.league}  ·  Expires: ${d.expires} UTC  ·  One-time use`;
    document.getElementById('pin-display').classList.add('show');
    loadPins();
    showToast('PIN generated — give it to the player');
  } else {
    showToast('Error: ' + (d.error || 'unknown'));
  }
}

async function loadPins() {
  const r = await fetch('/api/pins');
  const pins = await r.json();
  const tbody = document.getElementById('pins-tbody');
  if (!pins.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="padding:30px;text-align:center;color:var(--fg2);font-size:12px;">No PINs generated yet</td></tr>';
    return;
  }
  tbody.innerHTML = pins.map(p => `<tr>
    <td class="mono" style="letter-spacing:0.15em;">${p.pin}</td>
    <td class="mono">${p.league}</td>
    <td><span class="used-tag ${p.used ? '' : 'active'}">${p.used ? 'USED' : 'ACTIVE'}</span></td>
    <td class="dim">${esc(p.agent || '—')}</td>
    <td class="dim">${p.created}</td>
    <td class="dim">${p.expires}</td>
  </tr>`).join('');
}

// ── Admin ──
async function loadAdmin() {
  const r = await fetch('/api/admin/users');
  const users = await r.json();
  const tbody = document.getElementById('admin-tbody');
  tbody.innerHTML = users.map(u => `<tr>
    <td class="mono">${esc(u.username)}</td>
    <td>
      <select class="user-role-sel" onchange="updateUser(${u.id}, 'role', this.value)">
        <option ${u.role==='pending' ? 'selected':''}>pending</option>
        <option ${u.role==='agent'   ? 'selected':''}>agent</option>
        <option ${u.role==='owner'   ? 'selected':''}>owner</option>
      </select>
    </td>
    <td>
      <input style="background:var(--bg3);border:1px solid var(--bdr);color:var(--fg);font-family:DM Mono,monospace;font-size:11px;padding:4px 8px;outline:none;width:100px;"
        value="${esc(u.leagues)}"
        onblur="updateUser(${u.id}, 'leagues', this.value)"
        placeholder="UFF,FFL">
    </td>
    <td class="dim">${u.created}</td>
    <td>
      <button class="action-btn del" onclick="deleteUser(${u.id}, '${esc(u.username)}')">Remove</button>
    </td>
  </tr>`).join('');
}

async function updateUser(id, field, value) {
  await fetch(`/api/admin/users/${id}`, {
    method: 'PATCH',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({[field]: value})
  });
  showToast('User updated');
}

async function deleteUser(id, name) {
  if (!confirm(`Remove user "${name}"?`)) return;
  await fetch(`/api/admin/users/${id}`, {method:'DELETE'});
  loadAdmin();
  showToast('User removed');
}

// ── Helpers ──
function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// Init
loadStats();
loadScans('overview', '');
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lite — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1117;--bg2:#161b22;--bg3:#1c2333;--bg4:#21262d;
  --bdr:#30363d;--bdr2:#3d444d;
  --fg:#e6edf3;--fg2:#8b949e;--fg3:#484f58;
  --green:#2aff8f;--green-dim:rgba(42,255,143,0.15);
  --red:#f85149;--red-dim:rgba(248,81,73,0.12);
  --amber:#e3b341;--amber-dim:rgba(227,179,65,0.12);
  --blue:#58a6ff;--side:220px;
}
html,body{height:100%;background:var(--bg);color:var(--fg);font-family:'Inter',sans-serif;overflow:hidden;}
.shell{display:flex;height:100vh;}

/* Sidebar */
.sidebar{width:var(--side);background:var(--bg2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;flex-shrink:0;}
.sidebar-top{padding:16px;border-bottom:1px solid var(--bdr);}
.brand{display:flex;align-items:center;gap:10px;}
.brand-icon{width:30px;height:30px;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;flex-shrink:0;}
.brand-name{font-size:14px;font-weight:700;color:var(--fg);}
.brand-sub{font-size:10px;color:var(--fg2);}
.nav{flex:1;padding:8px 0;overflow-y:auto;}
.nav-section{font-size:10px;font-weight:600;letter-spacing:0.08em;color:var(--fg3);text-transform:uppercase;padding:12px 16px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:7px 16px;font-size:13px;color:var(--fg2);cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;user-select:none;}
.nav-item:hover{color:var(--fg);background:var(--bg3);}
.nav-item.active{color:var(--green);background:var(--green-dim);border-left-color:var(--green);}
.nav-item .ico{font-size:14px;width:16px;text-align:center;}
.sidebar-foot{padding:12px 16px;border-top:1px solid var(--bdr);}
.user-chip{display:flex;align-items:center;gap:8px;}
.user-av{width:28px;height:28px;border-radius:50%;background:var(--bg4);border:1px solid var(--bdr2);overflow:hidden;flex-shrink:0;}
.user-av img{width:100%;height:100%;object-fit:cover;}
.user-av-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--fg2);}
.user-name{font-size:12px;font-weight:500;}
.user-role{font-size:10px;color:var(--fg2);}
.logout{margin-left:auto;color:var(--fg3);font-size:18px;text-decoration:none;transition:color 0.1s;}
.logout:hover{color:var(--red);}

/* Content */
.content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:48px;background:var(--bg2);border-bottom:1px solid var(--bdr);display:flex;align-items:center;padding:0 24px;gap:12px;flex-shrink:0;}
.page-title{font-size:14px;font-weight:600;}
.page-badge{font-size:10px;font-weight:600;letter-spacing:0.06em;padding:2px 8px;background:var(--bg4);border:1px solid var(--bdr2);color:var(--fg2);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.filter-sel{background:var(--bg3);border:1px solid var(--bdr);color:var(--fg);font-family:'Inter',sans-serif;font-size:11px;padding:5px 10px;outline:none;cursor:pointer;}

.main{flex:1;overflow-y:auto;padding:24px;}
.panel{display:none;}
.panel.active{display:block;}

/* Stats */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--bdr);padding:16px 18px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card.red::before{background:var(--red);}
.stat-card.amber::before{background:var(--amber);}
.stat-card.green::before{background:var(--green);}
.stat-card.blue::before{background:var(--blue);}
.stat-label{font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--fg2);text-transform:uppercase;margin-bottom:8px;}
.stat-num{font-size:28px;font-weight:700;letter-spacing:-0.02em;}
.stat-sub{font-size:10px;color:var(--fg3);margin-top:3px;}

/* League split */
.league-split{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.league-card{background:var(--bg2);border:1px solid var(--bdr);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;}
.league-name{font-size:11px;font-weight:600;letter-spacing:0.06em;color:var(--fg2);text-transform:uppercase;}
.league-count{font-size:24px;font-weight:700;color:var(--fg);}

/* Section */
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.section-title{font-size:10px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg2);}

/* Table */
.table-wrap{background:var(--bg2);border:1px solid var(--bdr);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--fg2);padding:9px 14px;border-bottom:1px solid var(--bdr);background:var(--bg3);}
tbody tr{border-bottom:1px solid var(--bdr);cursor:pointer;transition:background 0.08s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--bg3);}
td{padding:11px 14px;font-size:12px;color:var(--fg);}
td.mono{font-family:monospace;font-size:11px;}
td.dim{color:var(--fg2);font-size:11px;}

/* Verdict pills */
.vp{display:inline-block;font-size:10px;font-weight:600;letter-spacing:0.04em;padding:2px 8px;text-transform:uppercase;}
.vp.CHEATER{color:var(--red);background:var(--red-dim);border:1px solid rgba(248,81,73,0.3);}
.vp.SUSPICIOUS{color:var(--amber);background:var(--amber-dim);border:1px solid rgba(227,179,65,0.3);}
.vp.CLEAN{color:var(--green);background:var(--green-dim);border:1px solid rgba(42,255,143,0.3);}
.vp.UNKNOWN{color:var(--fg2);background:var(--bg4);border:1px solid var(--bdr);}

/* PIN panel */
.pin-gen-card{background:var(--bg2);border:1px solid var(--bdr);padding:24px;margin-bottom:20px;max-width:480px;}
.pin-gen-title{font-size:14px;font-weight:600;margin-bottom:4px;}
.pin-gen-sub{font-size:12px;color:var(--fg2);margin-bottom:16px;}
.pin-row{display:flex;gap:8px;}
.league-sel,.btn-input{background:var(--bg3);border:1px solid var(--bdr);color:var(--fg);font-family:'Inter',sans-serif;font-size:12px;padding:8px 12px;outline:none;cursor:pointer;flex:1;}
.btn{background:var(--green);color:#000;border:none;font-family:'Inter',sans-serif;font-size:12px;font-weight:600;padding:8px 16px;cursor:pointer;transition:opacity 0.1s;white-space:nowrap;}
.btn:hover{opacity:0.85;}
.btn-ghost{background:transparent;color:var(--fg2);border:1px solid var(--bdr);font-family:'Inter',sans-serif;font-size:11px;padding:6px 12px;cursor:pointer;transition:all 0.1s;}
.btn-ghost:hover{color:var(--fg);border-color:var(--bdr2);}
.pin-result{margin-top:16px;display:none;}
.pin-result.show{display:block;}
.pin-code-wrap{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
.pin-code{font-family:monospace;font-size:24px;font-weight:700;letter-spacing:0.18em;color:var(--green);background:var(--bg3);border:1px solid rgba(42,255,143,0.3);padding:12px 18px;}
.copy-btn{background:var(--bg4);border:1px solid var(--bdr);color:var(--fg2);font-size:11px;padding:8px 12px;cursor:pointer;transition:all 0.1s;font-family:'Inter',sans-serif;}
.copy-btn:hover{color:var(--fg);}
.pin-meta{font-size:11px;color:var(--fg2);}
.pin-link{font-size:11px;color:var(--blue);margin-top:4px;}
.pin-link a{color:var(--blue);text-decoration:none;}
.pin-link a:hover{text-decoration:underline;}
.used-tag{font-size:10px;font-weight:600;padding:2px 7px;border:1px solid var(--bdr);color:var(--fg3);}
.used-tag.active{color:var(--green);border-color:rgba(42,255,143,0.3);background:var(--green-dim);}
.used-tag.used{color:var(--fg3);border-color:var(--bdr);}

/* Admin */
.user-role-sel{background:var(--bg3);border:1px solid var(--bdr);color:var(--fg);font-family:'Inter',sans-serif;font-size:11px;padding:3px 7px;outline:none;}
.act-btn{background:transparent;border:none;color:var(--fg2);font-family:'Inter',sans-serif;font-size:11px;cursor:pointer;padding:3px 8px;transition:color 0.1s;}
.act-btn:hover{color:var(--fg);}
.act-btn.del:hover{color:var(--red);}
.avatar-sm{width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:6px;}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--bdr2);color:var(--fg);font-size:12px;padding:10px 16px;z-index:200;opacity:0;transform:translateY(8px);transition:all 0.2s;pointer-events:none;}
.toast.show{opacity:1;transform:translateY(0);}

/* Scrollbar */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bg4);}
</style>
</head>
<body>
<div class="shell">
<nav class="sidebar">
  <div class="sidebar-top">
    <div class="brand">
      <div class="brand-icon">L</div>
      <div><div class="brand-name">Lite</div><div class="brand-sub">Forensic Portal</div></div>
    </div>
  </div>
  <div class="nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" onclick="switchPanel('overview',this)"><span class="ico">◈</span> Dashboard</div>
    <div class="nav-section">Leagues</div>
    <div class="nav-item" onclick="switchPanel('uff',this)"><span class="ico">◉</span> UFF Scans</div>
    <div class="nav-item" onclick="switchPanel('ffl',this)"><span class="ico">◉</span> FFL Scans</div>
    {% if role in ('owner','admin') %}
    <div class="nav-item" onclick="switchPanel('all',this)"><span class="ico">◈</span> All Scans</div>
    {% endif %}
    <div class="nav-section">Tools</div>
    <div class="nav-item" onclick="switchPanel('pins',this)"><span class="ico">◉</span> PIN Manager</div>
    {% if role in ('owner','admin') %}
    <div class="nav-section">Admin</div>
    <div class="nav-item" onclick="switchPanel('admin',this)"><span class="ico">◉</span> Users</div>
    {% endif %}
  </div>
  <div class="sidebar-foot">
    <div class="user-chip">
      <div class="user-av">
        {% if session.get('avatar') %}
        <img src="{{ session.get('avatar') }}" alt="">
        {% else %}
        <div class="user-av-placeholder">{{ user.username[0].upper() }}</div>
        {% endif %}
      </div>
      <div><div class="user-name">{{ user.username }}</div><div class="user-role">{{ user.role }}</div></div>
      <a href="/logout" class="logout" title="Sign out">↪</a>
    </div>
  </div>
</nav>

<div class="content">
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <div class="page-badge" id="page-badge">OVERVIEW</div>
    <div class="topbar-right">
      <select class="filter-sel" id="global-filter" onchange="applyFilter()">
        <option value="ALL">All Leagues</option>
        <option value="UFF">UFF</option>
        <option value="FFL">FFL</option>
      </select>
    </div>
  </div>

  <div class="main">

    <!-- OVERVIEW -->
    <div class="panel active" id="panel-overview">
      <div class="stats-row">
        <div class="stat-card red"><div class="stat-label">Cheaters</div><div class="stat-num" id="s-cheater">—</div><div class="stat-sub">Flagged</div></div>
        <div class="stat-card amber"><div class="stat-label">Suspicious</div><div class="stat-num" id="s-susp">—</div><div class="stat-sub">Needs review</div></div>
        <div class="stat-card green"><div class="stat-label">Clean</div><div class="stat-num" id="s-clean">—</div><div class="stat-sub">No findings</div></div>
        <div class="stat-card blue"><div class="stat-label">Total Scans</div><div class="stat-num" id="s-total">—</div><div class="stat-sub">All time</div></div>
      </div>
      {% if role in ('owner','admin') %}
      <div class="league-split">
        <div class="league-card"><div><div class="league-name">UFF</div><div style="font-size:11px;color:var(--fg2);margin-top:2px;">Total scans</div></div><div class="league-count" id="s-uff">—</div></div>
        <div class="league-card"><div><div class="league-name">FFL</div><div style="font-size:11px;color:var(--fg2);margin-top:2px;">Total scans</div></div><div class="league-count" id="s-ffl">—</div></div>
      </div>
      {% endif %}
      <div class="section-head"><div class="section-title">Recent Scans</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>League</th><th>Verdict</th><th>Hits</th><th>Roblox</th><th>Submitted</th><th>Results</th></tr></thead>
        <tbody id="overview-tbody"><tr><td colspan="7" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>

    <!-- UFF -->
    <div class="panel" id="panel-uff">
      <div class="section-head"><div class="section-title">UFF — Scan Results</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>Verdict</th><th>Hits</th><th>Roblox</th><th>Submitted</th><th>Results</th></tr></thead>
        <tbody id="uff-tbody"><tr><td colspan="6" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>

    <!-- FFL -->
    <div class="panel" id="panel-ffl">
      <div class="section-head"><div class="section-title">FFL — Scan Results</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>Verdict</th><th>Hits</th><th>Roblox</th><th>Submitted</th><th>Results</th></tr></thead>
        <tbody id="ffl-tbody"><tr><td colspan="6" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>

    {% if role in ('owner','admin') %}
    <!-- ALL -->
    <div class="panel" id="panel-all">
      <div class="section-head"><div class="section-title">All Scans — Admin View</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>PC User</th><th>League</th><th>Verdict</th><th>Hits</th><th>Roblox</th><th>Submitted</th><th>Results</th></tr></thead>
        <tbody id="all-tbody"><tr><td colspan="7" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>
    {% endif %}

    <!-- PINS -->
    <div class="panel" id="panel-pins">
      <div class="pin-gen-card">
        <div class="pin-gen-title">Generate scan PIN</div>
        <div class="pin-gen-sub">Create a one-time PIN to give to the player being screenshared. Expires in 4 hours, deleted after 3 days.</div>
        <div class="pin-row">
          <select class="league-sel" id="pin-league">
            {% for l in leagues %}<option value="{{ l }}">{{ l }}</option>{% endfor %}
          </select>
          <button class="btn" onclick="generatePin()">Generate PIN</button>
        </div>
        <div class="pin-result" id="pin-result">
          <div class="pin-code-wrap">
            <div class="pin-code" id="pin-code">————————</div>
            <button class="copy-btn" onclick="copyPin()">Copy</button>
          </div>
          <div class="pin-meta" id="pin-meta"></div>
          <div class="pin-link" id="pin-link"></div>
        </div>
      </div>
      <div class="section-head">
        <div class="section-title">PIN History</div>
        <button class="btn-ghost" onclick="loadPins()">Refresh</button>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>PIN</th><th>League</th><th>Status</th><th>Agent</th><th>Created</th><th>Expires</th><th>Finished</th><th>Results</th></tr></thead>
        <tbody id="pins-tbody"><tr><td colspan="8" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>

    {% if role in ('owner','admin') %}
    <!-- ADMIN -->
    <div class="panel" id="panel-admin">
      <div class="section-head"><div class="section-title">User Management</div></div>
      <div class="table-wrap"><table>
        <thead><tr><th>User</th><th>Discord ID</th><th>Role</th><th>Leagues</th><th>Joined</th><th>Actions</th></tr></thead>
        <tbody id="admin-tbody"><tr><td colspan="6" style="padding:30px;text-align:center;color:var(--fg2)">Loading…</td></tr></tbody>
      </table></div>
    </div>
    {% endif %}

  </div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const ROLE = "{{ role }}";
const LEAGUES = {{ leagues | tojson }};
let currentPanel = 'overview';
let lastPin = '';

const PAGE_INFO = {
  overview:['Dashboard','OVERVIEW'],uff:['UFF Scans','UFF'],
  ffl:['FFL Scans','FFL'],all:['All Scans','ADMIN'],
  pins:['PIN Manager','TOOLS'],admin:['User Management','ADMIN'],
};

function switchPanel(key, el) {
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+key).classList.add('active');
  if(el) el.classList.add('active');
  currentPanel = key;
  const [t,b] = PAGE_INFO[key]||[key,key];
  document.getElementById('page-title').textContent = t;
  document.getElementById('page-badge').textContent = b;
  if(key==='overview'){loadStats();loadScans('overview','');}
  else if(key==='uff') loadScans('uff','UFF');
  else if(key==='ffl') loadScans('ffl','FFL');
  else if(key==='all') loadScans('all','');
  else if(key==='pins'){loadPins();}
  else if(key==='admin') loadAdmin();
}

function applyFilter(){
  const v = document.getElementById('global-filter').value;
  loadStats();
  if(currentPanel==='overview') loadScans('overview', v==='ALL'?'':v);
  else if(currentPanel==='all') loadScans('all', v==='ALL'?'':v);
}

async function loadStats(){
  const r = await fetch('/api/stats');
  const d = await r.json();
  document.getElementById('s-cheater').textContent = d.cheater;
  document.getElementById('s-susp').textContent = d.suspicious;
  document.getElementById('s-clean').textContent = d.clean;
  document.getElementById('s-total').textContent = d.total;
  if(ROLE==='owner'||ROLE==='admin'){
    document.getElementById('s-uff').textContent = d.uff;
    document.getElementById('s-ffl').textContent = d.ffl;
  }
}

async function loadScans(panel, league){
  const url = '/api/scans'+(league?`?league=${league}`:'');
  const r = await fetch(url);
  const scans = await r.json();
  const isAll = panel==='overview'||panel==='all';
  const tid = panel==='overview'?'overview-tbody':panel+'-tbody';
  const tbody = document.getElementById(tid);
  if(!tbody) return;
  if(!scans.length){
    tbody.innerHTML=`<tr><td colspan="${isAll?7:6}" style="padding:30px;text-align:center;color:var(--fg2)">No scans yet</td></tr>`;
    return;
  }
  tbody.innerHTML = scans.map(s=>{
    const accs=(s.roblox_accs||[]).join(', ')||'—';
    const lg = isAll?`<td class="mono">${esc(s.league)}</td>`:'';
    return `<tr>
      <td class="mono">${esc(s.pc_user)}</td>${lg}
      <td><span class="vp ${s.verdict}">${s.verdict}</span></td>
      <td class="mono" style="color:${s.total_hits>0?'var(--red)':'var(--fg2)'}">${s.total_hits}</td>
      <td class="dim" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(accs)}</td>
      <td class="dim">${s.submitted}</td>
      <td>${s.pin_used?`<a href="/results/${s.pin_used}" style="color:var(--blue);font-size:11px;text-decoration:none" target="_blank">View →</a>`:'<span style="color:var(--fg3);font-size:11px">—</span>'}</td>
    </tr>`;
  }).join('');
}

async function generatePin(){
  const league = document.getElementById('pin-league').value;
  const r = await fetch('/api/pins/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({league})});
  const d = await r.json();
  if(d.pin){
    lastPin = d.pin;
    document.getElementById('pin-code').textContent = d.pin;
    document.getElementById('pin-meta').textContent = `League: ${d.league}  ·  Expires: ${d.expires} UTC  ·  One-time use`;
    document.getElementById('pin-link').innerHTML = `Results page: <a href="/results/${d.pin}" target="_blank">/results/${d.pin}</a>`;
    document.getElementById('pin-result').classList.add('show');
    loadPins();
    showToast('PIN generated');
  } else { showToast('Error: '+(d.error||'unknown')); }
}

function copyPin(){
  navigator.clipboard.writeText(lastPin).then(()=>showToast('Copied!'));
}

async function loadPins(){
  const r = await fetch('/api/pins');
  const pins = await r.json();
  const tbody = document.getElementById('pins-tbody');
  if(!pins.length){
    tbody.innerHTML='<tr><td colspan="8" style="padding:30px;text-align:center;color:var(--fg2)">No PINs yet</td></tr>';
    return;
  }
  tbody.innerHTML = pins.map(p=>`<tr>
    <td class="mono" style="letter-spacing:0.12em;color:var(--green)">${p.pin}</td>
    <td class="mono">${p.league}</td>
    <td><span class="used-tag ${p.used?'used':'active'}">${p.used?'USED':'ACTIVE'}</span></td>
    <td class="dim">${esc(p.agent||'—')}</td>
    <td class="dim">${p.created}</td>
    <td class="dim">${p.expires}</td>
    <td class="dim">${p.finished_at||'—'}</td>
    <td>${p.used&&p.scan_id?`<a href="/results/${p.pin}" style="color:var(--blue);font-size:11px;text-decoration:none" target="_blank">View →</a>`:'<span style="color:var(--fg3);font-size:11px">Pending</span>'}</td>
  </tr>`).join('');
}

async function loadAdmin(){
  const r = await fetch('/api/admin/users');
  const users = await r.json();
  const tbody = document.getElementById('admin-tbody');
  tbody.innerHTML = users.map(u=>`<tr>
    <td>${u.avatar?`<img src="https://cdn.discordapp.com/avatars/${u.discord_id}/${u.avatar}.png" class="avatar-sm">`:''}${esc(u.username)}</td>
    <td class="mono dim">${u.discord_id||'—'}</td>
    <td><select class="user-role-sel" onchange="updateUser(${u.id},'role',this.value)">
      <option ${u.role==='pending'?'selected':''}>pending</option>
      <option ${u.role==='agent'?'selected':''}>agent</option>
      <option ${u.role==='admin'?'selected':''}>admin</option>
      <option ${u.role==='owner'?'selected':''}>owner</option>
    </select></td>
    <td><input style="background:var(--bg3);border:1px solid var(--bdr);color:var(--fg);font-family:'Inter',sans-serif;font-size:11px;padding:3px 8px;outline:none;width:90px" value="${esc(u.leagues)}" onblur="updateUser(${u.id},'leagues',this.value)" placeholder="UFF,FFL"></td>
    <td class="dim">${u.created}</td>
    <td><button class="act-btn del" onclick="deleteUser(${u.id},'${esc(u.username)}')">Remove</button></td>
  </tr>`).join('');
}

async function updateUser(id,field,val){
  await fetch(`/api/admin/users/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({[field]:val})});
  showToast('Updated');
}

async function deleteUser(id,name){
  if(!confirm(`Remove "${name}"?`)) return;
  await fetch(`/api/admin/users/${id}`,{method:'DELETE'});
  loadAdmin(); showToast('Removed');
}

function esc(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

loadStats(); loadScans('overview','');
</script>
</body>
</html>

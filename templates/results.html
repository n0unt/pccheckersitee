<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lite — Scan Results</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0e1117;--bg2:#161b22;--bg3:#1c2333;--bg4:#21262d;
  --bdr:#30363d;--bdr2:#3d444d;
  --fg:#e6edf3;--fg2:#8b949e;--fg3:#484f58;
  --green:#2aff8f;--green-dim:rgba(42,255,143,0.12);
  --red:#f85149;--red-dim:rgba(248,81,73,0.12);
  --amber:#e3b341;--amber-dim:rgba(227,179,65,0.12);
  --blue:#58a6ff;
}
html,body{height:100%;background:var(--bg);color:var(--fg);font-family:'Inter',sans-serif;overflow:hidden;}
.shell{display:flex;height:100vh;}

/* Left sidebar — tabs */
.sidebar{width:200px;background:var(--bg2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;flex-shrink:0;}
.sidebar-top{padding:14px 16px;border-bottom:1px solid var(--bdr);}
.back-link{display:flex;align-items:center;gap:6px;color:var(--fg2);text-decoration:none;font-size:12px;transition:color 0.1s;margin-bottom:10px;}
.back-link:hover{color:var(--fg);}
.pin-badge{font-family:monospace;font-size:16px;font-weight:700;letter-spacing:0.12em;color:var(--green);}
.pin-league{font-size:10px;color:var(--fg2);margin-top:2px;}
.tab-list{flex:1;padding:8px 0;overflow-y:auto;}
.tab-section{font-size:9px;font-weight:600;letter-spacing:0.1em;color:var(--fg3);text-transform:uppercase;padding:10px 16px 4px;}
.tab-item{display:flex;align-items:center;gap:8px;padding:7px 16px;font-size:12px;color:var(--fg2);cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;user-select:none;}
.tab-item:hover{color:var(--fg);background:var(--bg3);}
.tab-item.active{color:var(--green);background:var(--green-dim);border-left-color:var(--green);}
.tab-item .hit-badge{margin-left:auto;font-size:10px;font-weight:600;padding:1px 6px;background:var(--red-dim);color:var(--red);border:1px solid rgba(248,81,73,0.2);}
.tab-item .hit-badge.clean{background:transparent;color:var(--fg3);border-color:transparent;}

/* Content */
.content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.topbar{height:48px;background:var(--bg2);border-bottom:1px solid var(--bdr);display:flex;align-items:center;padding:0 24px;gap:12px;flex-shrink:0;}
.page-title{font-size:14px;font-weight:600;}
.verdict-badge{font-size:11px;font-weight:700;padding:3px 10px;letter-spacing:0.04em;}
.verdict-badge.CHEATER{color:var(--red);background:var(--red-dim);border:1px solid rgba(248,81,73,0.3);}
.verdict-badge.SUSPICIOUS{color:var(--amber);background:var(--amber-dim);border:1px solid rgba(227,179,65,0.3);}
.verdict-badge.CLEAN{color:var(--green);background:var(--green-dim);border:1px solid rgba(42,255,143,0.3);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;font-size:11px;color:var(--fg2);}

.main{flex:1;overflow-y:auto;padding:24px;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Cards */
.info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.info-card{background:var(--bg2);border:1px solid var(--bdr);padding:14px 16px;}
.info-label{font-size:10px;font-weight:600;letter-spacing:0.06em;color:var(--fg2);text-transform:uppercase;margin-bottom:6px;}
.info-value{font-size:14px;font-weight:500;color:var(--fg);}
.info-value.mono{font-family:monospace;font-size:12px;}
.info-value.red{color:var(--red);}
.info-value.green{color:var(--green);}
.info-value.amber{color:var(--amber);}

/* Account cards */
.acc-card{background:var(--bg2);border:1px solid var(--bdr);padding:16px;margin-bottom:10px;}
.acc-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.acc-avatar{width:36px;height:36px;background:var(--bg4);border:1px solid var(--bdr2);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--green);flex-shrink:0;}
.acc-name{font-size:14px;font-weight:600;}
.acc-id{font-size:11px;color:var(--fg2);font-family:monospace;}
.acc-id a{color:var(--blue);text-decoration:none;}
.acc-id a:hover{text-decoration:underline;}
.acc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
.acc-field{background:var(--bg3);padding:10px 12px;}
.acc-field-label{font-size:9px;font-weight:600;letter-spacing:0.08em;color:var(--fg3);text-transform:uppercase;margin-bottom:4px;}
.acc-field-value{font-size:12px;color:var(--fg2);font-family:monospace;}
.multi-warn{background:var(--red-dim);border:1px solid rgba(248,81,73,0.3);color:var(--red);font-size:12px;padding:10px 14px;margin-bottom:14px;}

/* Detection rows */
.det-section{margin-bottom:20px;}
.det-title{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--fg2);margin-bottom:8px;display:flex;align-items:center;gap:8px;}
.det-count{font-size:10px;font-weight:700;padding:1px 7px;background:var(--red-dim);color:var(--red);border:1px solid rgba(248,81,73,0.2);}
.det-count.zero{background:transparent;color:var(--fg3);border-color:transparent;}
.det-row{background:var(--bg2);border:1px solid var(--bdr);padding:12px 14px;margin-bottom:4px;font-size:12px;font-family:monospace;color:var(--fg2);white-space:pre-wrap;word-break:break-all;line-height:1.6;}
.det-row.hit{border-left:2px solid var(--red);}
.det-row.warn{border-left:2px solid var(--amber);}
.det-row.ok{color:var(--fg3);}
.raw-pre{background:var(--bg2);border:1px solid var(--bdr);padding:16px;font-family:monospace;font-size:11px;color:var(--fg2);white-space:pre-wrap;word-break:break-all;max-height:400px;overflow-y:auto;line-height:1.6;}

/* Pending state */
.pending-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;color:var(--fg2);}
.pending-icon{font-size:40px;margin-bottom:16px;opacity:0.3;}
.pending-title{font-size:16px;font-weight:600;color:var(--fg);margin-bottom:6px;}
.pending-sub{font-size:13px;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bg4);}
</style>
</head>
<body>
{% set has_scan = scan is not none %}
{% set report = scan.report if has_scan else {} %}
{% set verdict = scan.verdict if has_scan else 'PENDING' %}
{% set roblox_accs = scan.roblox_accounts if has_scan else [] %}

<div class="shell">
<!-- Tab sidebar -->
<nav class="sidebar">
  <div class="sidebar-top">
    <a href="/dashboard" class="back-link">← Dashboard</a>
    <div class="pin-badge">{{ pin.pin }}</div>
    <div class="pin-league">{{ pin.league }} · {{ 'Completed' if has_scan else 'Pending' }}</div>
  </div>
  <div class="tab-list">
    <div class="tab-section">Overview</div>
    <div class="tab-item active" onclick="switchTab('summary',this)">◈ Summary</div>
    <div class="tab-section">Player</div>
    <div class="tab-item" onclick="switchTab('roblox',this)">
      ◉ Roblox
      <span class="hit-badge {{ 'clean' if not roblox_accs else '' }}">{{ roblox_accs|length }}</span>
    </div>
    <div class="tab-item" onclick="switchTab('discord',this)">◉ Discord</div>
    <div class="tab-section">System</div>
    <div class="tab-item" onclick="switchTab('sysanalysis',this)">
      ◉ System Analysis
      {% set sys_hits = (report.get('shellbag_hits',0)|int + report.get('bam_hits',0)|int + report.get('prefetch_hits',0)|int + report.get('appcompat_hits',0)|int + report.get('sysmain_hits',0)|int) %}
      <span class="hit-badge {{ 'clean' if sys_hits == 0 else '' }}">{{ sys_hits }}</span>
    </div>
    <div class="tab-item" onclick="switchTab('cheatfiles',this)">
      ◉ Cheat Files
      <span class="hit-badge {{ 'clean' if not report.get('cheat_hits',0)|int else '' }}">{{ report.get('cheat_hits',0) }}</span>
    </div>
    <div class="tab-item" onclick="switchTab('unsigned',this)">◉ Unsigned Files</div>
    <div class="tab-section">Additional</div>
    <div class="tab-item" onclick="switchTab('tamper',this)">◉ Tamper Detection</div>
    <div class="tab-item" onclick="switchTab('rawreport',this)">◉ Raw Report</div>
  </div>
</nav>

<div class="content">
  <div class="topbar">
    <div class="page-title">{{ scan.pc_user if has_scan else pin.pin }} — Scan Results</div>
    {% if has_scan %}
    <span class="verdict-badge {{ verdict }}">{{ verdict }}</span>
    {% endif %}
    <div class="topbar-right">
      {{ pin.league }} ·
      {% if has_scan %}Submitted {{ scan.submitted }}{% else %}Waiting for scan…{% endif %}
    </div>
  </div>

  <div class="main">

  {% if not has_scan %}
  <!-- PENDING -->
  <div class="pending-wrap">
    <div class="pending-icon">⏳</div>
    <div class="pending-title">Scan not completed yet</div>
    <div class="pending-sub">The player hasn't run the scan with this PIN yet.</div>
  </div>

  {% else %}

    <!-- SUMMARY -->
    <div class="tab-panel active" id="tab-summary">
      <div class="info-grid">
        <div class="info-card"><div class="info-label">PC User</div><div class="info-value mono">{{ scan.pc_user }}</div></div>
        <div class="info-card"><div class="info-label">League</div><div class="info-value mono">{{ scan.league }}</div></div>
        <div class="info-card"><div class="info-label">Total Hits</div><div class="info-value {{ 'red' if scan.total_hits > 0 else 'green' }}">{{ scan.total_hits }}</div></div>
        <div class="info-card"><div class="info-label">Submitted</div><div class="info-value mono" style="font-size:11px">{{ scan.submitted }}</div></div>
        <div class="info-card"><div class="info-label">PIN Finished</div><div class="info-value mono" style="font-size:11px">{{ pin.finished_at or '—' }}</div></div>
        <div class="info-card"><div class="info-label">Scan ID</div><div class="info-value mono">#{{ scan.id }}</div></div>
      </div>

      {% if report.get('sysmain_autofail') %}
      <div class="multi-warn" style="margin-bottom:14px">⚠ AUTO FAIL — SysMain disabled AND Prefetch empty. Deliberate trace wiping detected.</div>
      {% endif %}

      <div class="det-section">
        <div class="det-title">Detection Breakdown <span class="det-count {{ 'zero' if scan.total_hits == 0 else '' }}">{{ scan.total_hits }} hits</span></div>
        {% set rows = [
          ('ShellBag', report.get('shellbag_hits',0)),
          ('BAM', report.get('bam_hits',0)),
          ('Prefetch', report.get('prefetch_hits',0)),
          ('AppCompat', report.get('appcompat_hits',0)),
          ('Cheat Files', report.get('cheat_hits',0)),
          ('YARA', report.get('yara_hits',0)),
          ('Unsigned', report.get('unsigned_count',0)),
          ('SysMain', report.get('sysmain_hits',0)),
          ('Log Tamper', report.get('roblox_hits',0)|default(0)),
        ] %}
        {% for label, val in rows %}
        <div class="det-row {{ 'hit' if val|int > 0 else 'ok' }}">
          {{ '▲' if val|int > 0 else '○' }}  {{ label|ljust(20) }}  {{ val }}{{ '  ' + '█' * [val|int, 20]|min if val|int > 0 else '' }}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ROBLOX -->
    <div class="tab-panel" id="tab-roblox">
      {% if roblox_accs|length > 1 %}
      <div class="multi-warn">⚠ {{ roblox_accs|length }} Roblox accounts detected — possible ban evasion</div>
      {% endif %}
      {% for acc in roblox_accs %}
        {% if acc is mapping %}
        <div class="acc-card">
          <div class="acc-header">
            <div class="acc-avatar">{{ acc.username[0].upper() if acc.username and acc.username != 'Unknown' else '?' }}</div>
            <div>
              <div class="acc-name">{{ acc.username or 'Unknown' }}</div>
              <div class="acc-id">
                {% if acc.userid %}
                  ID: <a href="https://www.roblox.com/users/{{ acc.userid }}/profile" target="_blank">{{ acc.userid }} ↗</a>
                {% else %}Unknown ID{% endif %}
              </div>
            </div>
          </div>
          <div class="acc-grid">
            <div class="acc-field"><div class="acc-field-label">Last Seen</div><div class="acc-field-value">{{ acc.last_seen or '—' }}</div></div>
            <div class="acc-field"><div class="acc-field-label">Sources</div><div class="acc-field-value">{{ ', '.join(acc.sources) if acc.sources else '—' }}</div></div>
            <div class="acc-field" style="grid-column:1/-1"><div class="acc-field-label">Place IDs</div>
              <div class="acc-field-value">
                {% if acc.placeids %}
                  {% for pid in acc.placeids %}<a href="https://www.roblox.com/games/{{ pid }}" target="_blank" style="color:var(--blue);text-decoration:none">{{ pid }}</a>{% if not loop.last %}, {% endif %}{% endfor %}
                {% else %}—{% endif %}
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="acc-card">
          <div class="acc-name">{{ acc }}</div>
        </div>
        {% endif %}
      {% else %}
      <div style="color:var(--fg2);font-size:13px;padding:20px 0">No Roblox accounts detected.</div>
      {% endfor %}

      {% if report.get('fastflags') %}
      <div class="det-section" style="margin-top:20px">
        <div class="det-title">FastFlags Detected <span class="det-count">{{ report.fastflags|length }}</span></div>
        {% for ff in report.fastflags %}
        <div class="det-row warn">{{ ff }}</div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- DISCORD -->
    <div class="tab-panel" id="tab-discord">
      {% if report.get('discord_accounts') %}
      <div class="det-section">
        <div class="det-title">Discord Local Accounts <span class="det-count {{ 'zero' if not report.discord_accounts else '' }}">{{ report.discord_accounts|length }}</span></div>
        {% for acc in report.discord_accounts %}
        <div class="acc-card">
          <div class="acc-header">
            <div class="acc-avatar" style="background:var(--bg4);color:#5865F2;font-size:18px">D</div>
            <div>
              <div class="acc-name">{{ acc.username or 'Unknown' }}</div>
              <div class="acc-id">ID: {{ acc.id or '—' }}</div>
            </div>
          </div>
          <div class="acc-grid">
            <div class="acc-field"><div class="acc-field-label">Token Found</div><div class="acc-field-value" style="color:{{ 'var(--red)' if acc.has_token else 'var(--fg3)' }}">{{ 'YES' if acc.has_token else 'No' }}</div></div>
            <div class="acc-field"><div class="acc-field-label">Source</div><div class="acc-field-value">{{ acc.source or '—' }}</div></div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div style="color:var(--fg2);font-size:13px;padding:20px 0">No Discord account data found in local cache.</div>
      {% endif %}
    </div>

    <!-- SYSTEM ANALYSIS -->
    <div class="tab-panel" id="tab-sysanalysis">
      <div class="det-section">
        <div class="det-title">Factory Reset History</div>
        {% if report.get('factory_resets') %}
        <div class="det-row">{{ report.factory_resets }}</div>
        {% else %}
        <div class="det-row ok">No factory reset history found.</div>
        {% endif %}
      </div>
      <div class="det-section">
        <div class="det-title">SysMain / Prefetch Service <span class="det-count {{ 'zero' if not report.get('sysmain_hits',0)|int else '' }}">{{ report.get('sysmain_hits',0) }} hits</span></div>
        <div class="det-row {{ 'hit' if report.get('sysmain_hits',0)|int > 0 else 'ok' }}">{{ report.get('sysmain_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">ShellBags <span class="det-count {{ 'zero' if not report.get('shellbag_hits',0)|int else '' }}">{{ report.get('shellbag_hits',0) }} hits</span></div>
        <div class="raw-pre">{{ report.get('shellbags_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">BAM <span class="det-count {{ 'zero' if not report.get('bam_hits',0)|int else '' }}">{{ report.get('bam_hits',0) }} hits</span></div>
        <div class="raw-pre">{{ report.get('bam_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">Prefetch <span class="det-count {{ 'zero' if not report.get('prefetch_hits',0)|int else '' }}">{{ report.get('prefetch_hits',0) }} hits</span></div>
        <div class="raw-pre">{{ report.get('prefetch_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">AppCompat / UserAssist <span class="det-count {{ 'zero' if not report.get('appcompat_hits',0)|int else '' }}">{{ report.get('appcompat_hits',0) }} hits</span></div>
        <div class="raw-pre">{{ report.get('appcompat_raw','No data') }}</div>
      </div>
    </div>

    <!-- CHEAT FILES -->
    <div class="tab-panel" id="tab-cheatfiles">
      <div class="det-section">
        <div class="det-title">Cheat Files <span class="det-count {{ 'zero' if not report.get('cheat_hits',0)|int else '' }}">{{ report.get('cheat_hits',0) }} hits</span></div>
        <div class="raw-pre">{{ report.get('cheat_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">Deleted Cheat Files (Recycle Bin)</div>
        <div class="raw-pre">{{ report.get('recycle_raw','No data') }}</div>
      </div>
    </div>

    <!-- UNSIGNED -->
    <div class="tab-panel" id="tab-unsigned">
      <div class="det-section">
        <div class="det-title">Unsigned Executables <span class="det-count {{ 'zero' if not report.get('unsigned_count',0)|int else '' }}">{{ report.get('unsigned_count',0) }} found</span></div>
        <div class="raw-pre">{{ report.get('unsigned_raw','No data') }}</div>
      </div>
    </div>

    <!-- TAMPER -->
    <div class="tab-panel" id="tab-tamper">
      <div class="det-section">
        <div class="det-title">Log Integrity & Tamper Detection</div>
        <div class="raw-pre">{{ report.get('roblox_raw','No data') }}</div>
      </div>
      <div class="det-section">
        <div class="det-title">Drive Detection</div>
        {% if report.get('drive_info') %}
        <div class="det-row {{ 'warn' if report.get('drive_warn') else 'ok' }}">{{ report.drive_info }}</div>
        {% else %}
        <div class="det-row ok">No drive anomalies detected.</div>
        {% endif %}
      </div>
    </div>

    <!-- RAW -->
    <div class="tab-panel" id="tab-rawreport">
      <div class="raw-pre">{{ report.get('full_report','No raw report available.') }}</div>
    </div>

  {% endif %}
  </div>
</div>
</div>

<script>
function switchTab(key, el) {
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-item').forEach(t=>t.classList.remove('active'));
  const panel = document.getElementById('tab-'+key);
  if(panel) panel.classList.add('active');
  if(el) el.classList.add('active');
}
</script>
</body>
</html>

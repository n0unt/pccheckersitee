<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comet â€” Download</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#080b10;--surface:#0f1420;--surface2:#131925;--border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.1);--fg:#f0f4ff;--fg2:#8892a4;--fg3:#3d4a5c;--green:#00f5a0;--green-glow:rgba(0,245,160,0.15);--green-dim:rgba(0,245,160,0.08);}
html,body{background:var(--bg);color:var(--fg);font-family:'DM Sans',sans-serif;min-height:100%;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 10% 0%,rgba(0,245,160,0.03) 0%,transparent 50%);pointer-events:none;}
nav{position:sticky;top:0;background:rgba(8,11,16,0.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 40px;height:56px;display:flex;align-items:center;justify-content:space-between;z-index:100;}
.nav-brand{display:flex;align-items:center;gap:10px;text-decoration:none;}
.nav-mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--green),#00c97a);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:800;color:#000;}
.nav-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--fg);}
.nav-links{display:flex;align-items:center;gap:24px;}
.nav-links a{color:var(--fg2);text-decoration:none;font-size:13px;transition:color 0.15s;}
.nav-links a:hover,.nav-links a.active{color:var(--fg);}
.nav-links a.active{color:var(--green);}
.nav-btn{background:var(--green);color:#000;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;padding:7px 16px;cursor:pointer;text-decoration:none;}
.wrap{max-width:760px;margin:0 auto;padding:60px 24px 80px;}
.page-tag{font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--green);margin-bottom:12px;}
h1{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;margin-bottom:10px;}
.sub{font-size:15px;color:var(--fg2);margin-bottom:48px;line-height:1.6;}
.dl-card{background:var(--surface);border:1px solid var(--border2);border-radius:20px;padding:28px 32px;margin-bottom:16px;display:flex;align-items:center;gap:24px;}
.dl-icon{width:52px;height:52px;border-radius:14px;background:var(--green-dim);border:1px solid rgba(0,245,160,0.2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.dl-info{flex:1;}
.dl-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:4px;}
.dl-meta{font-size:12px;color:var(--fg2);font-family:'DM Mono',monospace;}
.dl-version{display:inline-block;font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;padding:2px 8px;border-radius:20px;background:var(--green-dim);border:1px solid rgba(0,245,160,0.2);color:var(--green);margin-left:8px;vertical-align:middle;}
.dl-btn{background:var(--green);color:#000;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;padding:12px 22px;cursor:pointer;text-decoration:none;white-space:nowrap;box-shadow:0 0 24px var(--green-glow);transition:all 0.2s;display:flex;align-items:center;gap:8px;}
.dl-btn:hover{opacity:0.9;transform:translateY(-1px);}
.dl-btn:disabled,.dl-btn.soon{background:var(--surface2);color:var(--fg3);box-shadow:none;cursor:default;transform:none;}
.instructions{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-top:32px;}
.inst-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px;}
.step{display:flex;gap:14px;margin-bottom:14px;}
.step-num{width:24px;height:24px;border-radius:50%;background:var(--green-dim);border:1px solid rgba(0,245,160,0.2);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:var(--green);flex-shrink:0;margin-top:1px;}
.step-text{font-size:13px;color:var(--fg2);line-height:1.6;}
.step-text strong{color:var(--fg);}

/* Admin upload section */
.upload-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-top:32px;display:none;}
.upload-card.show{display:block;}
.upload-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:6px;}
.upload-sub{font-size:12px;color:var(--fg2);margin-bottom:16px;}
.upload-row{display:flex;gap:10px;align-items:center;}
.file-input{background:var(--surface2);border:1px solid var(--border2);border-radius:10px;color:var(--fg);font-family:'DM Sans',sans-serif;font-size:12px;padding:9px 14px;flex:1;outline:none;cursor:pointer;}
.upload-btn{background:var(--green);color:#000;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;padding:9px 18px;cursor:pointer;white-space:nowrap;}
.upload-btn:hover{opacity:0.9;}
.upload-status{font-size:12px;margin-top:10px;}
</style>
</head>
<body>
<nav>
  <a href="/" class="nav-brand"><div class="nav-mark">L</div><div class="nav-name">Comet</div></a>
  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/download" class="active">Download</a>
    <a href="/terms">Terms</a>
    <a href="/privacy">Privacy</a>
    {% if user %}
    <a href="/dashboard" class="nav-btn">Dashboard</a>
    {% else %}
    <a href="/login" class="nav-btn">Sign In</a>
    {% endif %}
  </div>
</nav>
<div class="wrap">
  <div class="page-tag">Software</div>
  <h1>Download Comet Scanner</h1>
  <p class="sub">The Comet scanner runs locally on Windows and submits results to the dashboard via your PIN.</p>

  <div class="dl-card">
    <div class="dl-icon">ðŸ–¥</div>
    <div class="dl-info">
      <div class="dl-name">Comet Scanner <span class="dl-version" id="ver-tag">{{ version or 'v3.0' }}</span></div>
      <div class="dl-meta" id="dl-meta">Windows 10/11 Â· {{ file_size or '~8 MB' }} Â· Updated {{ updated or 'recently' }}</div>
    </div>
    {% if download_url %}
    <a href="/download/exe" class="dl-btn">â†“ Download .exe</a>
    {% else %}
    <button class="dl-btn soon" disabled>No build uploaded yet</button>
    {% endif %}
  </div>

  <div class="instructions">
    <div class="inst-title">How to use</div>
    <div class="step"><div class="step-num">1</div><div class="step-text">An agent will give you a <strong>PIN code</strong> before the screenshare begins.</div></div>
    <div class="step"><div class="step-num">2</div><div class="step-text">Download and run the <strong>.exe file</strong> above. Windows SmartScreen may warn you â€” click "More info" then "Run anyway".</div></div>
    <div class="step"><div class="step-num">3</div><div class="step-text">Read and accept the <strong>Terms of Service</strong> that appear on launch.</div></div>
    <div class="step"><div class="step-num">4</div><div class="step-text">Enter the <strong>PIN</strong> provided by the agent, select your league, and click <strong>Run Scan</strong>.</div></div>
    <div class="step"><div class="step-num">5</div><div class="step-text">Results are automatically sent to the dashboard. The scan takes 1â€“3 minutes.</div></div>
  </div>

  {% if user and user.role in ('owner','admin') %}
  <div class="upload-card show">
    <div class="upload-title">Upload new build</div>
    <div class="upload-sub">Upload a new .exe to replace the current download. The version tag and file will update automatically.</div>
    <div class="upload-row">
      <input type="file" class="file-input" id="exe-file" accept=".exe">
      <input type="text" class="file-input" id="ver-input" placeholder="Version tag (e.g. v3.1)" style="max-width:150px">
      <button class="upload-btn" onclick="uploadBuild()">Upload</button>
    </div>
    <div class="upload-status" id="upload-status"></div>
  </div>
  {% endif %}
</div>

<script>
async function uploadBuild(){
  const fileInput = document.getElementById('exe-file');
  const ver = document.getElementById('ver-input').value.trim() || 'v3.0';
  const status = document.getElementById('upload-status');
  if(!fileInput.files.length){ status.style.color='var(--amber)'; status.textContent='Please select a file.'; return; }
  const file = fileInput.files[0];
  status.style.color='var(--fg2)'; status.textContent=`Uploading ${file.name} (${(file.size/1024/1024).toFixed(1)} MB)â€¦`;
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('version', ver);
    const r = await fetch('/api/admin/upload-exe', {method:'POST', body:fd});
    const d = await r.json();
    if(d.ok){
      status.style.color='var(--green)';
      status.textContent=`âœ“ Uploaded ${d.version} (${d.size}). Refresh to confirm.`;
      setTimeout(()=>location.reload(), 1500);
    } else {
      status.style.color='var(--red)';
      status.textContent='Error: '+(d.error||'unknown');
    }
  } catch(e){
    status.style.color='var(--red)';
    status.textContent='Upload failed: '+e.message;
  }
}
</script>
</body>
</html>
